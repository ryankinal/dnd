const trinkets = {
	dmg14: {
		label: 'DMG (2014)',
		options: [
			"A mummified goblin hand",
			"A piece of crystal that faintly glows in the moonlight",
			"A gold coin minted in an unknown land",
			"A diary written in a language you don't know",
			"A brass ring that never tarnishes",
			"An old chess piece made from glass",
			"A pair of knucklebone dice, each with a skull symbol on the side that would normally show six pips",
			"A small idol depicting a nightmarish creature that gives you unsettling dreams when you sleep near it",
			"A rope necklace from which dangles four mummified elf fingers",
			"The deed for a parcel of land in a realm unknown to you",
			"A 1-ounce block made from an unknown material",
			"A small cloth doll skewered with needles",
			"A tooth from an unknown beast",
			"An enormous scale, perhaps from a dragon",
			"A bright green feather",
			"An old divination card bearing your likeness",
			"A glass orb filled with moving smoke",
			"A 1-pound egg with a bright red shell",
			"A pipe that blows bubbles",
			"A glass jar containing a weird bit of flesh floating in pickling fluid",
			"A tiny gnome-crafted music box that plays a song you dimly remember from your childhood",
			"A small wooden statuette of a smug halfling",
			"A brass orb etched with strange runes",
			"A multicolored stone disk",
			"A tiny silver icon of a raven",
			"A bag containing forty-seven humanoid teeth, one of which is rotten",
			"A shard of obsidian that always feels warm to the touch",
			"A dragon's bony talon hanging from a plain leather necklace",
			"A pair of old socks",
			"A blank book whose pages refuse to hold ink, chalk, graphite, or any other substance or marking",
			"A silver badge in the shape of a five-pointed star",
			"A knife that belonged to a relative",
			"A glass vial filled with nail clippings",
			"A rectangular metal device with two tiny metal cups on one end that throws sparks when wet",
			"A white, sequined glove sized for a human",
			"A vest with one hundred tiny pockets",
			"A small, weightless stone block",
			"A tiny sketch portrait of a goblin",
			"An empty glass vial that smells of perfume when opened",
			"A gemstone that looks like a lump of coal when examined by anyone but you",
			"A scrap of cloth from an old banner",
			"A rank insignia from a lost legionnaire",
			"A tiny silver bell without a clapper",
			"A mechanical canary inside a gnome-crafted lamp",
			"A tiny chest carved to look like it has numerous feet on the bottom",
			"A dead sprite inside a clear glass bottle",
			"A metal can that has no opening but sounds as if it is filled with liquid, sand, spiders, or broken glass (your choice)",
			"A glass orb filled with water, in which swims a clockwork goldfish",
			"A silver spoon with an M engraved on the handle",
			"A whistle made from gold-colored wood",
			"A dead scarab beetle the size of your hand",
			"Two toy soldiers, one with a missing head",
			"A small box filled with different-sized buttons",
			"A candle that can't be lit",
			"A tiny cage with no door",
			"An old key",
			"An indecipherable treasure map",
			"A hilt from a broken sword",
			"A rabbit's foot",
			"A glass eye",
			"A cameo carved in the likeness of a hideous person",
			"A silver skull the size of a coin",
			"An alabaster mask",
			"A pyramid of sticky black incense that smells very bad",
			"A nightcap that, when worn, gives you pleasant dreams",
			"A single caltrop made from bone",
			"A gold monocle frame without the lens",
			"A 1-inch cube, each side painted a different color",
			"A crystal knob from a door",
			"A small packet filled with pink dust",
			"A fragment of a beautiful song, written as musical notes on two pieces of parchment",
			"A silver teardrop earring made from a real teardrop",
			"The shell of an egg painted with scenes of human misery in disturbing detail",
			"A fan that, when unfolded, shows a sleeping cat",
			"A set of bone pipes",
			"A four-leaf clover pressed inside a book discussing manners and etiquette",
			"A sheet of parchment upon which is drawn a complex mechanical contraption",
			"An ornate scabbard that fits no blade you have found so far",
			"An invitation to a party where a murder happened",
			"A bronze pentacle with an etching of a rat's head in its center",
			"A purple handkerchief embroidered with the name of a powerful archmage",
			"Half of a floorplan for a temple, castle, or some other structure",
			"A bit of folded cloth that, when unfolded, turns into a stylish cap",
			"A receipt of deposit at a bank in a far-flung city",
			"A diary with seven missing pages",
			"An empty silver snuffbox bearing an inscription on the surface that says \"dreams\"",
			"An iron holy symbol devoted to an unknown god",
			"A book that tells the story of a legendary hero's rise and fall, with the last chapter missing",
			"A vial of dragon blood",
			"An ancient arrow of elven design",
			"A needle that never bends",
			"An ornate brooch of dwarven design",
			"An empty wine bottle bearing a pretty label that says, \"The Wizard of Wines Winery, Red Dragon Crush, 331422-W\"",
			"A mosaic tile with a multicolored, glazed surface",
			"A petrified mouse",
			"A black pirate flag adorned with a dragon's skull and crossbones",
			"A tiny mechanical crab or spider that moves about when it's not being observed",
			"A glass jar containing lard with a label that reads, \"Griffon Grease\"",
			"A wooden box with a ceramic bottom that holds a living worm with a head on each end of its body",
			"A metal urn containing the ashes of a hero"
		]
	},
	cos: {
		label: 'Curse of Strahd',
		options: [
			"A picture you drew as a child of your imaginary friend",
			"A lock that opens when blood is dripped in its keyhole",
			"Clothes stolen from a scarecrow",
			"A spinning top carved with four faces: happy, sad, wrathful, and dead",
			"The necklace of a sibling who died on the day you were born",
			"A wig from someone executed by beheading",
			"The unopened letter to you from your dying father",
			"A pocket watch that runs backward for an hour every midnight",
			"A winter coat stolen from a dying soldier",
			"A bottle of invisible ink that can only be read at sunset",
			"A wineskin that refills when interred with a dead person for a night",
			"A set of silverware used by a king for his last meal",
			"A spyglass that always shows the world suffering a terrible storm",
			"A cameo with the profile's face scratched away",
			"A lantern with a black candle that never runs out and that burns with green flame",
			"A teacup from a child's tea set, stained with blood",
			"A little black book that records your dreams, and yours alone, when you sleep",
			"A necklace formed of the interlinked holy symbols of a dozen deities",
			"A hangman's noose that feels heavier than it should",
			"A birdcage into which small birds fly but once inside never eat or leave",
			"A lepidopterist's box filled dead moths with skull-like patterns on their wings",
			"A jar of pickled ghouls' tongues",
			"The wooden hand of a notorious pirate",
			"A urn with the ashes of a dead relative",
			"A hand mirror backed with a bronze depiction of a medusa",
			"Pallid leather gloves crafted with ivory fingernails",
			"Dice made from the knuckles of a notorious charlatan",
			"A ring of keys for forgotten locks",
			"Nails from the coffin of a murderer",
			"A key to the family crypt",
			"An bouquet of funerary flowers that always looks and smells fresh",
			"A switch used to discipline you as a child",
			"A music box that plays by itself whenever someone holding it dances",
			"A walking cane with an iron ferrule that strikes sparks on stone",
			"A flag from a ship lost at sea",
			"Porcelain doll's head that always seems to be looking at you",
			"A wolf's head wrought in silver that is also a whistle.",
			"A small mirror that shows a much older version of the viewer",
			"Small, worn book of children's nursery rhymes.",
			"A mummified raven claw",
			"A broken pendent of a silver dragon that's always cold to the touch",
			"A small locked box that quietly hums a lovely melody at night but you always forget it in the morning",
			"An inkwell that makes one a little nauseous when staring at it",
			"An old little doll made from a dark, dense wood and missing a hand and a foot",
			"A black executioner's hood",
			"A pouch made of flesh, with a sinew drawstring",
			"A tiny spool of black thread that never runs out",
			"A tiny clockwork figurine of a dancer that's missing a gear and doesn't work",
			"A black wooden pipe that creates puffs of smoke that look like skulls",
			"A vial of perfume, the scent of which only certain creatures can detect"
		]
	},
	twbtw: {
		label: 'Feywild',
		options: [
			"Cookie cutter shaped like a unicorn",
			"Two yew rings linked together",
			"Silver hand mirror with a nymph-shaped handle",
			"Painted wooden key whose teeth change configuration every day at dawn",
			"Delicate silver cameo with pictures of twin children opposite one another",
			"Golden pendant charm shaped like a leprechaun",
			"Tiny wooden box containing a croquet set sized for pixies or sprites",
			"Tiny pair of sharp, iron scissors",
			"Chess piece shaped like a dancing satyr wearing a bishop's hat and clutching a gnarled staff",
			"Saltshaker shaped like a wizard's tower",
			"Crystal orb that allows an elf who holds it to sleep",
			"Pendant that shows the phases of the moon",
			"Large iron fingernail",
			"Tiny electrum whistle that only Fey can hear",
			"Wooden jigsaw puzzle piece as big as a saucer, with a painted image of a jug on it",
			"Spool of glistening silver thread",
			"Sheet of music that goblins find upsetting when they hear it played or sung",
			"Rotten ogre's tooth with the Elvish glyph for \"moon\" etched into it",
			"Vitrified eye of a displacer beast",
			"Tiny duskwood coffin containing the ashes of a troll",
			"Old invitation to a banquet in the Summer Court, written in ink on vellum in Sylvan",
			"Gossamer shawl that glows faintly in moonlight",
			"Ball-and-cup toy that plays a short, victorious jingle whenever the ball lands in the cup",
			"Sprite's skull covered in ink fingerprints",
			"Silver fork with the outer tines bent sideways",
			"A soot-stained sock in which a nugget of coal magically appears each day at dawn",
			"Tiny wooden stool (sized for a pixie or sprite) that gives splinters to those who hold it",
			"Tiny clockwork dragonfly that slowly beats its wings (but can't fly) when wound up",
			"Toy unicorn made of wood, painted with bright colors",
			"Pixie plushie that sings when you squeeze it",
			"1-inch-square painting of a sleeping elf",
			"Thimble that helps you daydream when worn",
			"Pumpkin cupcake that magically regenerates itself in its paper cup each day at dawn",
			"Fake Three-Dragon Ante card depicting a faerie dragon",
			"Teacup made from a varnished mushroom cap that magically keeps its liquid contents lukewarm",
			"Rock that floats and is small enough to hide in your closed fist",
			"Tiny bottle filled with rainwater collected from the Feywild",
			"Opalescent conch shell that laughs when you hold it to your ear",
			"Vial of viscous liquid labeled \"Fomorian spit. Do not drink!\"",
			"Wax candle that roars and crackles like a bonfire while lit",
			"Potted daffodil that sways when near a source of music",
			"8-ounce, glass wine bottle that magically reassembles itself 1 minute after being broken",
			"Tiny wooden sylph figurehead from a model ship",
			"Tiny pumpkin-shaped cauldron carved out of bog oak",
			"Bar of soap that smells like something memorable from your childhood",
			"Piece of orange parchment folded to look like a knight astride a unicorn",
			"Tinted glasses so dark that they can't be seen through",
			"8-inch-long glass ant figurine",
			"Piece of parchment bearing a child's drawing of an oni",
			"Tiny hourglass without sand in it",
			"Empty vial with corked ends at the top and bottom",
			"Pair of green leprechaun boots tied together by their laces",
			"Smoking pipe made from a tree root",
			"Red cap that droops down to one's shoulders when worn",
			"Mask that helps you remember your dreams if you wear it while you sleep",
			"Notebook that shows what's written on it only when held upside down",
			"Wooden top with four sides, each bearing the image of child enjoying a different season",
			"Tiny beehive wig made for sprites or pixies",
			"Wooden mouse figurine that squeaks when held",
			"Stuffed oni doll with a creepy smile and one missing eye",
			"Empty bag labeled \"Candy\"",
			"Tinted glass monocle that makes things look green",
			"Black executioner's hood sized for a pixie or sprite",
			"Piano key carved from a satyr's horn",
			"Tiny wooden lute with cat hairs for strings",
			"Iron needle with an eye that refuses to let thread pass through it",
			"Tiny sundial that casts a shadow only in moonlight",
			"Wooden pan flute that attracts harmless local fauna when played",
			"Silvered pinecone",
			"Flask of spectral glowworms that change color to reflect the mood of the flask's holder",
			"Wooden apple painted blue",
			"Tuning fork that sounds the tone for the F key",
			"Nunchaku sized for a pixie or sprite",
			"Copper coin with a smiling satyr's face on one side and a satyr's skull on the other",
			"Severed chicken's foot attached to a leather cord",
			"Collection of baby teeth in a tiny wooden box",
			"Pinwheel whirligig that spins even when there's no wind",
			"Child's parasol covered in moss and leaves",
			"Wooden magnifying glass missing its lens",
			"Glossy mushroom with a red, bell-shaped cap that jingles when shook",
			"Pouch of seeds that smell like home",
			"Petrified robin's egg",
			"Wooden spoon with a hole in the center",
			"Paper wasp nest in a jar",
			"Sprig of rosemary wrapped with ribbon at one end",
			"Tiny, unfurnished dollhouse sized for a pixie child",
			"Paintbrush made entirely of ceramic—even the bristles",
			"Candlestick whose candlelight looks like a tiny, dancing fairy made of fire",
			"Spectacle frames in the shape of butterfly wings",
			"Set of false wooden teeth",
			"Tiny book of fairytales",
			"Rucksack in which one potato magically appears each day at dawn",
			"Pixie's winter jacket lined with fox fur",
			"Tasseled wine charm shaped like a sprite",
			"Weak magnetic wand",
			"100-sided die the size of a plum, cut from coal",
			"Glass slipper, missing its mate",
			"Tiny dreamcatcher",
			"Barbell sized for a pixie or sprite",
			"Music box that plays a sprightly tune you remember from your childhood"
		]
	}
};

const icons = {
	box: 'fa-solid fa-box',
	jar: 'fa-solid fa-jar',
	bottle: 'fa-solid fa-wine-bottle',
	urn: 'fa-solid fa-jar',
	bag: 'fa-solid fa-sack-xmark',
	sack: 'fa-solid fa-sack-xmark',
	pouch: 'fa-solid fa-sack-xmark',
	skull: 'fa-solid fa-skull',
	orb: 'fa-solid fa-circle-notch',
	cube: 'fa-solid fa-cube',
	block: 'fa-solid fa-cube',
	map: 'fa-solid fa-map',
	vest: 'fa-solid fa-vest',
	hand: 'fa-solid fa-hand',
	book: 'fa-solid fa-book',
	diary: 'fa-solid fa-book',
	wine: 'fa-solid fa-wine-bottle',
	vial: 'fa-solid fa-vial',
	pipe: 'fa-solid fa-bong',
	dragon: 'fa-solid fa-dragon',
	unicorn: 'fa-solid fa-chess-knight',
	// unicorn: 'fa-solid fa-chess-unicorn', // Fontawesome pro
	raven: 'fa-solid fa-crow',
	cat: 'fa-solid fa-cat',
	// mouse: 'fa-solid fa-mouse-field', // Fontawesome pro
	bug: 'fa-solid fa-bug',
	beetle: 'fa-solid fa-bug',
	bell: 'fa-solid fa-bell',
	figurine: 'fa-solid fa-chess-knight',
	statuette: 'fa-solid fa-chess-knight',
	charm: 'fa-solid fa-chess-bishop',
	cup: 'fa-solid fa-beer-mug-empty',
	music: 'fa-solid fa-music',
	wand: 'fa-solid fa-wand-sparkles',
	die: 'fa-solid fa-dice-d6',
	dice: 'fa-solid fa-dice',
	glasses: 'fa-solid fa-glasses',
	spectacles: 'fa-solid fa-glasses',
	key: 'fa-solid fa-key',
	keys: 'fa-solid fa-key',
	ring: 'fa-solid fa-ring',
	teeth: 'fa-solid fa-tooth',
	tooth: 'fa-solid fa-tooth',
	eye: 'fa-solid fa-eye',
	parchment: 'fa-solid fa-sheet-plastic',
	sheet: 'fa-solid fa-sheet-plastic',
	invitation: 'fa-solid fa-sheet-plastic',
	coin: 'fa-solid fa-coins',
	spoon: 'fa-solid fa-spoon',
	clothes: 'fa-sold fa-shirt',
	// flute: 'fa-solid fa-flute', // Fontawesome pro
	// whistle: 'fa-solid fa-flute', // Fontawesome pro
	egg: 'fa-solid fa-egg',
	feather: 'fa-solid fa-feather-painted',
	// candle: 'fa-solid fa-candle-holder', // Fontawesome pro
	mask: 'fa-solid fa-mask',
	paint: 'fa-solid fa-paintbrush',
	necklace: 'fa-solid fa-gem',
	brooch: 'fa-solid fa-gem',
	teacup: 'fa-solid fa-mug-hot',
	doll: 'fa-solid fa-baby',
	pirate: 'fa-solid fa-skull-crossbones',
	flag: 'fa-solid fa-flag',
	mirror: 'fa-solid fa-circle-half-stroke',
	// fork: 'fa-solid fa-fork', // Fontawesome pro
	crystal: 'fa-solid fa-gem',
	shard: 'fa-solid fa-gem',
	bone: 'fa-solid fa-bone',
	mechanical: 'fa-solid fa-gear',
	clockwork: 'fa-solid fa-gear',
	foot: 'fa-solid fa-shoe-prints',
	blood: 'fa-solid fa-droplet',
	chess: 'fa-solid fa-chess-knight',
	// mushroom: 'fa-solid fa-mushroom', // Fontawesome pro
	// card: 'fa-solid fa-card-spade' // Fontawesome pro
};

let defaultIcon = 'fa-solid fa-box';

let ignoreTokens = [
	'card',
	'fork',
	'liquid',
	'labeled',
	'while',
	'tinted',
	'through',
	'oni',
	'down',
	'held',
	'tiny,',
	'appears',
	'helps',
	'paper',
	'mushroom',
	'covered',
	'leprechaun',
	'pixies',
	'sprites',
	'dancing',
	'hear',
	'image',
	'they',
	'together',
	'change',
	'pendant',
	'played',
	'cup',
	'stolen',
	'wig',
	'someone',
	'dying',
	'every',
	'winter',
	'night',
	'used',
	'face',
	'their',
	'notorious',
	'coffin',
	'whenever',
	'ship',
	"that's",
	'makes',
	"executioner's",
	'hood',
	'spool',
	'not',
	'being',
	'holds',
	'small,',
	'unfolded,',
	'ornate',
	'bronze',
	'center',
	'folded',
	'surface',
	'holy',
	'last',
	'design',
	'needle',
	'label',
	'petrified',
	'small',
	'unfolded',
	'mouse',

	'monocle',
	'lens',
	'different',
	'color',
	'teardrop',
	'unfolded',
	'sleeping',

	'rotten',
	'feels',
	'touch',
	"dragon's",
	'pages',
	'shape',
	'relative',
	'sparks',
	'human',
	'small',
	'lost',
	'has',
	'sounds',
	'handle',
	'small',
	'whistle',
	'wood',
	'lit',
	'door',
	'person',
	'likeness',
	'smoke',
	'bit',
	'gnome-crafted',
	'etched',
	'symbol',
	'depicting',
	'near',
	'block',
	'beast',
	'brass',
	'cameo',
	'that',
	'that,',
	'itself',
	'worn',
	'thread',
	"satyr's",
	"goblin",
	'faintly',
	'glows',
	'gold',
	'land',
	'into',
	'ashes',
	'top',
	'who',
	'runs',
	'ink',
	'out',
	"child's",
	'little',
	'wings',
	'candle',
	"can't",
	'size',
	'toy',
	'bottom',
	'stone',
	'other',
	'end',
	'looks',
	'without',
	'shell',
	'coal',
	'remember',
	'childhood',
	'leather',
	'whose',
	'hold',
	'red',
	'cloth',
	'bright',
	'set',
	'cap',
	'child',
	'dawn',
	'mummified',
	'moonlight',
	'side',
	'gives',
	'dreams',
	'four',
	'elf',
	'broken',
	'necklace',
	'jar',
	'that',
	'with',
	'the',
	'from',
	'when',
	'you',
	'for',
	'and',
	'made',
	'like',
	'your',
	'one',
	'small',
	'tiny',
	'wooden',
	'glass',
	'silver',
	'box',
	'which',
	'filled',
	'missing',
	'black',
	'its',
	'old',
	'each',
	'piece',
	'containing',
	'always',
	'sized',
	'unknown',
	'never',
	'bearing',
	'empty',
	'carved',
	'shows',
	'iron',
	'day',
	'only',
	'shaped',
	'magically',
	'unknown',
	'written',
	'pair',
	'green',
	'plays',
	'metal',
	'two',
	'smells',
	'but',
	'inside',
	'look',
	'can',
	'hand',
	'book',
	'vial',
	'dragon',
	'dead',
	'painted',
	'pixie',
	'skull',
	'dragon',
	'music',
	'sprite',
	'bottle',
	'head',
	'key',
	'sleep'
];

ignoreTokens = ignoreTokens.concat(Object.keys(icons));

let selected = ['dmg14'];
const savedSelected = localStorage.getItem('trinket-sources-selected');

if (savedSelected) {
	const parsed = JSON.parse(savedSelected);

	if (parsed) {
		selected = parsed;
	}
}

let search = window.location.search;
let queryString = search && search.replace(/^\?/, '').split('&').map((item) => {
		if (typeof item !== 'string') {
			return true;
		}

		const parts = item.split('=');

		return {
			name: parts[0],
			value: parts.length > 1 ? parts[1] : null
		}
	}).reduce((output, input) => {
		output[input.name] = input.value;
		return output;
	}, {});

const displayButton = document.getElementById('display');
const rollButton = document.getElementById('doIt');
const showOptions = document.querySelector('.multiselect-show-options');
const blanket = document.getElementById('blanket');
const selectedOutput = document.querySelector('.multiselect-selected');
const optionsOutput = document.querySelector('.multiselect-options');
const resultOutput = document.querySelector('.output');

Object.keys(trinkets).forEach((key) => {
	const elem = document.createElement('div');
	elem.className = 'multiselect-option';
	
	const textContainer = document.createElement('div');
	textContainer.className = 'multiselect-option-text';
	textContainer.innerText = trinkets[key].label;

	const removeButton = document.createElement('div');
	removeButton.className = 'multiselect-option-remove';
	removeButton.innerHTML = '<i class="fa fa-circle-xmark"></i>';

	removeButton.addEventListener('click', (e) => {
		e.stopPropagation();
		e.preventDefault();

		optionsOutput.appendChild(elem);
		selected.splice(selected.indexOf(key), 1);
		localStorage.setItem('trinket-sources-selected', JSON.stringify(selected));

		if (selected.length < Object.keys(trinkets).length) {
			showOptions.classList.remove('hidden');
		}

		if (selected.length === 0) {
			selectedOutput.innerHTML = '<span class="empty">Nothing selected &raquo; select a source</span>'
		}
	});

	elem.addEventListener('click', (e) => {
		e.stopPropagation();
		e.preventDefault();

		if (selected.indexOf(key) < 0) {
			if (selected.length === 0) {
				selectedOutput.innerHTML = '';
			}
			
			selected.push(key);
			localStorage.setItem('trinket-sources-selected', JSON.stringify(selected));
			selectedOutput.appendChild(elem);

			if (selected.length === Object.keys(trinkets).length) {
				showOptions.classList.add('hidden');
			}

			optionsOutput.classList.add('hidden');
			blanket.classList.add('hidden');
		}
	});

	elem.appendChild(textContainer);
	elem.appendChild(removeButton);

	if (selected.indexOf(key) >= 0) {
		selectedOutput.appendChild(elem);
	} else {
		optionsOutput.appendChild(elem);
	}
});

showOptions.addEventListener('click', (e) => {
	if (optionsOutput.classList.contains('hidden') && selected.length < Object.keys(trinkets).length) {
		optionsOutput.classList.remove('hidden');
		blanket.classList.remove('hidden');
	} else {
		optionsOutput.classList.add('hidden');
		blanket.classList.add('hidden');
	}
});

blanket.addEventListener('click', () => {
	blanket.classList.add('hidden');
	optionsOutput.classList.add('hidden');
})

function getRandomCollection() {
	return selected.length && selected[Math.floor(Math.random() * selected.length)];
}

function getCurrentOptions() {
	return selected.reduce((out, key) => {
			if (trinkets[key] && Array.isArray(trinkets[key].options)) {
				out = out.concat(trinkets[key].options);
			}

			return out;
		}, []).reduce((out, option) => {
			if (out.indexOf(option) < 0) {
				out.push(option);
			}

			return out;
		}, []);
}

function renderTrinket(collection, trinket) {
	let options = trinkets[collection].options;

	if (typeof trinket !== 'number') {
		trinket = Math.floor(Math.random() * options.length);
	}

	history.replaceState({ collection: collection, trinket: trinket }, '', '/trinkets/?collection=' + collection + '&trinket=' + trinket)

	const option = options[trinket];
	let regex = new RegExp('(' + Object.keys(icons).map((key) => '\\b' + key + '\\b').join('|') + ')', 'g');
	let match = option.match(regex);
	let icon = defaultIcon;

	if (match) {
		icon = icons[match[0]];
	}

	resultOutput.classList.add('result');
	resultOutput.innerHTML = `<div class="icon"><i class="${icon}"></i></div>
								<p>${option}</p>`;
	rollButton.classList.remove('rolling');
}

rollButton.addEventListener('click', () => {
	const collection = getRandomCollection();
	
	resultOutput.innerHTML = '';
	resultOutput.classList.remove('result');
	resultOutput.classList.remove('table');

	if (collection) {
		rollButton.classList.add('rolling');
		resultOutput.innerHTML = '<span class="fas fa-compass fa-spin"></span>';

		setTimeout(() => {
			renderTrinket(collection);
		}, 400);
	}
});

displayButton.addEventListener('click', () => {
	let options = getCurrentOptions();
	resultOutput.innerHTML = '';
	resultOutput.classList.remove('result');
	resultOutput.classList.remove('table');

	if (options.length) {
		resultOutput.classList.remove('result');
		resultOutput.classList.remove('table');
		resultOutput.innerHTML = '<span class="fas fa-compass fa-spin"></span>';

		const table = document.createElement('table');
		const header = document.createElement('thead');
		const headerRow = document.createElement('tr');
		const dieOutput = document.createElement('th')
		const trinketOutput = document.createElement('th');

		dieOutput.innerText = 'd' + options.length;
		trinketOutput.innerText = 'Trinket';

		headerRow.appendChild(dieOutput);
		headerRow.appendChild(trinketOutput);
		header.appendChild(headerRow);
		table.appendChild(header);

		const body = document.createElement('tbody');

		options.forEach((option, index) => {
			const row = document.createElement('tr');
			const resultOutput = document.createElement('td');
			const valueOutput = document.createElement('td');

			resultOutput.innerHTML = index + 1;
			valueOutput.innerHTML = option;
			row.appendChild(resultOutput);
			row.appendChild(valueOutput);
			body.appendChild(row);
		});

		setTimeout(() => {
			resultOutput.classList.add('table');
			displayButton.classList.remove('rolling');
			table.appendChild(body);
			resultOutput.innerHTML = '';
			resultOutput.appendChild(table);
		}, 400);
	}
});

let tokens = Object.keys(trinkets)
	.map((key) => trinkets[key])
	.reduce((out, source) => {
		return out.concat(source.options);
	}, [])
	.reduce((out, option) => {
		return out.concat(option.split(/\s+/g));
	}, [])
	.filter((token) => {
		token = token.toLowerCase();
		return token.length > 2 && ignoreTokens.indexOf(token) < 0;
	})
	.reduce((counts, token) => {
		token = token.toLowerCase();

		if (typeof counts[token] === 'undefined') {
			counts[token] = {
				token: token,
				count: 0
			};
		}

		counts[token].count++;

		return counts;
	}, {});

tokens = Object.values(tokens).sort((a, b) => b.count - a.count);

if (selected.length === Object.keys(trinkets).length) {
	showOptions.classList.add('hidden');
}

if (selected.length === 0) {
	selectedOutput.innerHTML = '<span class="empty">Nothing selected &raquo; select a source</span>'
}

if (queryString.collection && typeof queryString.trinket === 'string') {
	renderTrinket(queryString.collection, parseInt(queryString.trinket));
}

/*resultOutput.innerText = JSON.stringify(tokens, null, 4);
resultOutput.style.whiteSpace = 'pre';
resultOutput.style.textAlign = 'left';*/